PCA feature selection
========================================================

### Prep Work (copied from svm_predictions to be consistent in saved data format)

**First, run import_and_clean_clinical_data.Rmd and join_rna_seq_data_with_design.R.**

**Load libraries.**
```{r}
library(plyr)
library(kernlab)
library(taRifx)
library(cvTools)
```

**Now, let's remove the columns with NA values - we won't use them at this time.**
```{r}
complete_cols <- lapply(joined_dat,function(x) {all(!is.na(x))})
dat_complete <- joined_dat[unlist(complete_cols)]
```

Part 1: Predicting Cytogenetic Risk
-------------------------

### Part 1a: Data clean-up

**First, let's reorder the factor levels for Cytogenetic_risk so they make sense.**
```{r}
levels(dat_complete$Cytogenetic_risk) <- c("Poor","Intermediate","Good","N.D.")
```

**Remove the rows with N.D.**
```{r}
dat_filt <- subset(dat_complete,dat_complete$Cytogenetic_risk != "N.D.")
```

**Now, for the SVM, let's make a binary prognosis columns (TRUE for poor).**
```{r}
dat_in <- dat_filt
dat_in$prognosis <- mapvalues(dat_in$Cytogenetic_risk, c("Good","Intermediate","Poor"), c(0,0,1), warn_missing = TRUE)
#dat_svm$prognosis <- mapvalues(dat_svm$Cytogenetic_risk, c("Good","Intermediate","Poor"), c(TRUE,FALSE,FALSE), warn_missing = TRUE)
```

**Make prelimary dataset with gene columns + prognosis + cyt risk.**
```{r}
prelim_in <- dat_in[,grepl(".*calculated",colnames(dat_in))]
prelim_in <- dat_in[,c(colnames(prelim_in),"prognosis","Cytogenetic_risk")]
```

**kernel PCA**
```{r}
library(geigen)
kernel_pca <- function(x.tr, x.ts, label.tr, d, flag){
  #x.tr and x.ts are feature*sample
  # flag =TRUE is for supervised kernel PCA and flag= False is for kernel pca
  # "d" is the dimension of the data in the new feature space
  n <- dim(x.tr)[2]
  I <- diag(n)
  e <- rep(1, n)
  s <- 1/n
  H <- I - s*tcrossprod(e)
  if (flag==TRUE){
    L <- label.tr %*% t(label.tr)
    cat("Flag is true\n")
    }else{
    cat("Flag is false\n")
    L <- I    
  }
    
  k <- t(x.tr) %*% x.tr
  Q <- k %*% H %*% L %*% H %*% k
  Q.svd <- svd(Q, nu=d, nv=d)
  U <- Q.svd$u[,1:d]
  V <- Q.svd$v[,1:d]
  D <- Q.svd$d[1:d]
  beta <- geigen(Q, k)
  mapped.tr <- beta$vectors %*% k
  mapped.ts <- beta$vectors %*% t(x.tr) %*% x.ts
  
  list(tr.dat=mapped.tr[1:d,], ts.dat=mapped.ts[1:d,])
}

```
```{r}
run_svm <- function(x.tr, x.ts){
  conf_matrix <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))
  #fit.svm <- ksvm(xtrain,label.tr,type="C-svc",kernel="rbfdot")
  fit_svm <- ksvm(prognosis~.,x.tr)
  pred_svm <- predict(fit_svm,newdata=x.ts,type="response")
  
  #fit.svm <- ksvm(xtrain,label.tr)
  #pred_svm <- predict(fit.svm,newdata=x.ts)
  results <- table(x.ts$prognosis,pred_svm)
  print(results)
  conf_matrix[1,1] <- conf_matrix[1,1] + results[1,1]
  conf_matrix[1,2] <- conf_matrix[1,2] + results[1,2]
  conf_matrix[2,1] <- conf_matrix[2,1] + results[2,1]
  conf_matrix[2,2] <- conf_matrix[2,2] + results[2,2]
  
  sens_svm <- conf_matrix[1,1]/sum(conf_matrix[1,])
  spec_svm <- conf_matrix[2,2]/sum(conf_matrix[2,])
  cat("Sensitvity = ", sens_svm, "\n")
  cat("Specificity = ", spec_svm, "\n")
  
}

```

```{r}
test <- sample(1:137,30)
x.ts <- t(data.matrix(prelim_in[test,grepl(".*calculated",colnames(prelim_in))]))
ytest <- prelim_in[test,c("prognosis")]
x.tr <- t(data.matrix(prelim_in[-test,grepl(".*calculated",colnames(prelim_in))]))
ytrain <- prelim_in[-test,c("prognosis")]

d=10

#kernel PCA
res <- kernel_pca((x.tr), (x.ts), as.numeric(levels(ytrain))[ytrain], d, FALSE)
xtrain <- t(res$tr.dat)
xtest <- t(res$ts.dat)
plot(xtrain[, 1:2], bg=ytrain, pch=21, cex=1.5)
xtrain.ker <- cbind(xtrain, prelim_in[-30:-1,c("prognosis","Cytogenetic_risk")])
xtest.ker <- cbind(xtest, prelim_in[1:30,c("prognosis","Cytogenetic_risk")])
run_svm(xtrain.ker, xtest.ker)


#R kernel PCA
xtest <- prelim_in[test,grepl(".*calculated",colnames(prelim_in))]
xtrain <- prelim_in[-test,grepl(".*calculated",colnames(prelim_in))]
kpc <- kpca(~.,data=xtrain,kernel="rbfdot", kpar=list(sigma=0.2),features=2)
plot(rotated(kpc),col=as.integer(ytrain),xlab="1st Principal Component",ylab="2nd Principal Component")
emb <- predict(kpc,xtest)
points(emb,col=as.integer(ytest))
xtrain.ker.r <- cbind(rotated(kpc), prelim_in[-test,c("prognosis","Cytogenetic_risk")])
xtest.ker.r <- cbind(emb, prelim_in[test,c("prognosis","Cytogenetic_risk")])
run_svm(xtrain.ker.r, xtest.ker.r)

#Supervised PCA

sup.res <- kernel_pca((x.tr), (x.ts), as.numeric(levels(ytrain))[ytrain], d, TRUE)
sup.ts <- t(sup.res$ts.dat)
sup.tr <- t(sup.res$tr.dat)
plot(sup.tr[, 1:2], bg=ytrain, pch=21, cex=1.5)
xtrain.supervised <- cbind(sup.tr, prelim_in[-30:-1,c("prognosis","Cytogenetic_risk")])
xtest.supervised <- cbind(sup.ts, prelim_in[1:30,c("prognosis","Cytogenetic_risk")])
run_svm(xtrain.supervised, xtest.supervised)

#basic PCA
princomp <- prcomp(prelim_in[,grepl(".*calculated",colnames(prelim_in))], center = T, scale = F)
plot(princomp$x[1:30, 1:2], bg=ytest, pch=21, cex=1.5)
xtrain.basic <- cbind(princomp$x[-30:-1, 1:d], prelim_in[-30:-1,c("prognosis","Cytogenetic_risk")])
xtest.basic <- cbind(princomp$x[1:30, 1:d], prelim_in[1:30,c("prognosis","Cytogenetic_risk")])
run_svm(xtrain.basic, xtest.basic)

#
#rst = nsprcomp(prelim_in[,grepl(".*calculated",colnames(prelim_in))], retx=T, nneg=T)


# #ICA
# library(fastICA)
# Icomp <- fastICA(prelim_in[,grepl(".*calculated",colnames(prelim_in))], 2, alg.typ = "deflation", fun = "logcosh", alpha = 1, method = "R", row.norm = FALSE, maxit = 200,tol = 0.0001, verbose = TRUE)
# xtrain.ica <- cbind(Icomp$X[folds$subsets[folds$which!=f,], 1:d], prelim_in[folds$subsets[folds$which!=f,],c("prognosis","Cytogenetic_risk")])
# xtest.ica <- cbind(Icomp$X[folds$subsets[folds$which==f,], 1:d], prelim_in[folds$subsets[folds$which==f,],c("prognosis","Cytogenetic_risk")])
# run_svm(xtrain.ica, xtest.ica)
```








**Prepare folds and confusion matrix for cross validation.**
```{r}
k<- 5
folds <- cvFolds(nrow(prelim_in), K = k)
conf_matrix_ker <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))
conf_matrix_sup <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))
conf_matrix_basic <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))
conf_matrix_ker_R <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))
conf_matrix_ica <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))



#conf_matrix <- matrix(0,nrow=2,ncol=2,dimnames=list(c("trueNotGood","trueGood"),c("predNotGood","predGood")))
```

**Perform cross validation.**
```{r}
for (f in 1:k) {

#   # Divide preliminary dataset into train and test sets.
#   prelim_train <- prelim_in[folds$subsets[folds$which!=f,],]
#   prelim_test <- prelim_in[folds$subsets[folds$which==f],]
#   prelim_test_labels <- prelim_test$prognosis
  
  
  x.ts <- t(data.matrix(prelim_in[folds$subsets[folds$which==f,],grepl(".*calculated",colnames(prelim_in))]))
  ytest <- prelim_in[folds$subsets[folds$which==f,],c("prognosis")]
  x.tr <- t(data.matrix(prelim_in[folds$subsets[folds$which!=f,],grepl(".*calculated",colnames(prelim_in))]))
  ytrain <- prelim_in[folds$subsets[folds$which!=f,],c("prognosis")]
  d = 10
  
  #kernel PCA
  res <- kernel_pca((x.tr), (x.ts),  as.numeric(levels(ytrain))[ytrain], d, FALSE)
  xtrain <- t(res$tr.dat)
  xtest <- t(res$ts.dat)
  xtrain <- cbind(xtrain, prelim_in[folds$subsets[folds$which!=f,],c("prognosis","Cytogenetic_risk")])
  xtest <- cbind(xtest, prelim_in[folds$subsets[folds$which==f,],c("prognosis","Cytogenetic_risk")])

  fit_svm <- ksvm(prognosis~.,xtrain)
  pred_svm <- predict(fit_svm,newdata=xtest,type="response")

  results <- table(ytest,pred_svm)
  
  conf_matrix_ker[1,1] <- conf_matrix_ker[1,1] + results[1,1]
  conf_matrix_ker[1,2] <- conf_matrix_ker[1,2] + results[1,2]
  conf_matrix_ker[2,1] <- conf_matrix_ker[2,1] + results[2,1]
  conf_matrix_ker[2,2] <- conf_matrix_ker[2,2] + results[2,2] 
  ###############
  #supervised PCA
  cat("supervised PCA\n")
  sup.res <- kernel_pca((x.tr), (x.ts), as.numeric(levels(ytrain))[ytrain], d, TRUE)
  sup.ts <- t(sup.res$ts.dat)
  sup.tr <- t(sup.res$tr.dat)
  xtrain.supervised <- cbind(sup.tr, prelim_in[folds$subsets[folds$which!=f,],c("prognosis","Cytogenetic_risk")])
  xtest.supervised <- cbind(sup.ts, prelim_in[folds$subsets[folds$which==f,],c("prognosis","Cytogenetic_risk")])
  
  fit_svm <- ksvm(prognosis~.,xtrain.supervised)
  pred_svm <- predict(fit_svm,newdata=xtest.supervised,type="response")

  results <- table(ytest,pred_svm)
  
  conf_matrix_sup[1,1] <- conf_matrix_sup[1,1] + results[1,1]
  conf_matrix_sup[1,2] <- conf_matrix_sup[1,2] + results[1,2]
  conf_matrix_sup[2,1] <- conf_matrix_sup[2,1] + results[2,1]
  conf_matrix_sup[2,2] <- conf_matrix_sup[2,2] + results[2,2] 
  ##############
  cat("basic PCA\n")
  #basic PCA
  princomp <- prcomp(prelim_in[,grepl(".*calculated",colnames(prelim_in))], center = T, scale = F)
  xtrain.basic <- cbind(princomp$x[folds$subsets[folds$which!=f,], 1:d], prelim_in[folds$subsets[folds$which!=f,],c("prognosis","Cytogenetic_risk")])
  xtest.basic <- cbind(princomp$x[folds$subsets[folds$which==f,], 1:d], prelim_in[folds$subsets[folds$which==f,],c("prognosis","Cytogenetic_risk")])
  fit_svm <- ksvm(prognosis~.,xtrain.basic)
  pred_svm <- predict(fit_svm,newdata=xtest.basic,type="response")

  results <- table(ytest,pred_svm)
  
  conf_matrix_basic[1,1] <- conf_matrix_basic[1,1] + results[1,1]
  conf_matrix_basic[1,2] <- conf_matrix_basic[1,2] + results[1,2]
  conf_matrix_basic[2,1] <- conf_matrix_basic[2,1] + results[2,1]
  conf_matrix_basic[2,2] <- conf_matrix_basic[2,2] + results[2,2] 
  cat("R kernel PCA \n")
  #R kernel PCA
  xtest.ker.R <- prelim_in[folds$subsets[folds$which==f,],grepl(".*calculated",colnames(prelim_in))]
  xtrain.ker.R <- prelim_in[folds$subsets[folds$which!=f,],grepl(".*calculated",colnames(prelim_in))]
  kpc <- kpca(~.,data=xtrain.ker.R,kernel="rbfdot", kpar=list(sigma=0.2),features=2)
  emb <- predict(kpc,xtest.ker.R)
  xtrain.ker.r <- cbind(rotated(kpc), prelim_in[folds$subsets[folds$which!=f,],c("prognosis","Cytogenetic_risk")])
  xtest.ker.r <- cbind(emb, prelim_in[folds$subsets[folds$which==f,],c("prognosis","Cytogenetic_risk")])
  
  fit_svm <- ksvm(prognosis~.,xtrain.ker.r)
  pred_svm <- predict(fit_svm,newdata=xtest.ker.r,type="response")

  results <- table(ytest,pred_svm)
  
  conf_matrix_ker_R[1,1] <- conf_matrix_ker_R[1,1] + results[1,1]
  conf_matrix_ker_R[1,2] <- conf_matrix_ker_R[1,2] + results[1,2]
  conf_matrix_ker_R[2,1] <- conf_matrix_ker_R[2,1] + results[2,1]
  conf_matrix_ker_R[2,2] <- conf_matrix_ker_R[2,2] + results[2,2] 
   
  ##########
#   cat("ICA \n")
#   #ICA
#   Icomp <- fastICA(prelim_in[,grepl(".*calculated",colnames(prelim_in))], 2, alg.typ = "deflation", fun = "logcosh", alpha = 1, method = "R", row.norm = FALSE, maxit = 200,tol = 0.0001, verbose = TRUE)
#   xtrain.ica <- cbind(Icomp$X[folds$subsets[folds$which!=f,], 1:d], prelim_in[folds$subsets[folds$which!=f,],c("prognosis","Cytogenetic_risk")])
#   xtest.ica <- cbind(Icomp$X[folds$subsets[folds$which==f,], 1:d], prelim_in[folds$subsets[folds$which==f,],c("prognosis","Cytogenetic_risk")])
#   fit_svm <- ksvm(prognosis~.,xtrain.ica)
#   pred_svm <- predict(fit_svm,newdata=xtest.ica,type="response")
# 
#   results <- table(ytest,pred_svm)
#   
#   conf_matrix_ica[1,1] <- conf_matrix_ica[1,1] + results[1,1]
#   conf_matrix_ica[1,2] <- conf_matrix_ica[1,2] + results[1,2]
#   conf_matrix_ica[2,1] <- conf_matrix_ica[2,1] + results[2,1]
#   conf_matrix_ica[2,2] <- conf_matrix_ica[2,2] + results[2,2] 
#   
}
```

**Process CV results.**
```{r}
(sens_svm_basic <- conf_matrix_basic[1,1]/sum(conf_matrix_basic[1,]))
(spec_svm_basic <- conf_matrix_basic[2,2]/sum(conf_matrix_basic[2,]))


(sens_svm_ker <- conf_matrix_ker[1,1]/sum(conf_matrix_ker[1,]))
(spec_svm_ker <- conf_matrix_ker[2,2]/sum(conf_matrix_ker[2,]))


(sens_svm_sup <- conf_matrix_sup[1,1]/sum(conf_matrix_sup[1,]))
(spec_svm_sup <- conf_matrix_sup[2,2]/sum(conf_matrix_sup[2,]))

(sens_svm_ker_R <- conf_matrix_ker_R[1,1]/sum(conf_matrix_ker_R[1,]))
(spec_svm_ker_R <- conf_matrix_ker_R[2,2]/sum(conf_matrix_ker_R[2,]))

```


