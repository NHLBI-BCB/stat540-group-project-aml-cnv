PCA Analysis
================
### Prep Work (copied from svm_predictions to be consistent in saved data format)

**First, run import_and_clean_clinical_data.Rmd and join_rna_seq_data_with_design.R.**
```{r}
#rna_seq_dat <-read.table("data/aml.rnaseq.gaf2.0_rpkm_cleaned.txt", sep = "\t", header = TRUE, check.names = FALSE)
rna_seq_dat <-read.table("data/aml.rnaseq.gaf2.0_read_count_cleaned.txt", sep = "\t", header = TRUE, check.names = FALSE)

rna_seq_dat_norm <- rna_seq_dat
#rna_seq_dat_norm <- rna_seq_dat[,apply(rna_seq_dat, 2, var, na.rm=TRUE) != 0]
#rna_seq_dat_norm <- rna_seq_dat[apply(t(rna_seq_dat), 2, var, na.rm=TRUE) != 0,]

exp_dat <- read.table("data/experimental_design_cleaned.txt", 
                           sep = "\t", header = TRUE, row.names = 1)

joined_dat <- cbind(exp_dat,t(rna_seq_dat_norm))
# source(purl("code/import_and_clean_clinical_data.Rmd"))
# source("code/join_rna_seq_data_with_design.R")
```

**Load libraries.**
```{r}
library(plyr)
library(kernlab)
library(taRifx)
library(cvTools)
```
**Now, let's remove the columns with NA values - we won't use them at this time.**
```{r}
complete.cols <- lapply(joined_dat,function(x) {all(!is.na(x))})
dat.complete <- joined_dat[unlist(complete.cols)]
```
**First, let's reorder the factor levels for Cytogenetic_risk so they make sense.**
```{r}
levels(dat.complete$Cytogenetic_risk) <- c("Poor","Intermediate","Good","N.D.")
```
**Remove the rows with N.D.**
```{r}
dat.filt <- subset(dat.complete,dat.complete$Cytogenetic_risk != "N.D.")
```

**let's make a binary prognosis columns (TRUE for poor).**
```{r}
dat.in <- dat.filt
dat.in$prognosis <- mapvalues(dat.in$Cytogenetic_risk, c("Good","Intermediate","Poor"), c(0,0,1), warn_missing = TRUE)
```

**Make prelimary dataset with gene columns + prognosis + cyt risk.**
```{r}
prelim.in <- dat.in[,grepl("_*calculated",colnames(dat.in))]
gene.name <- colnames(prelim.in)
prelim.in <- dat.in[,c(colnames(prelim.in),"prognosis","Cytogenetic_risk")]
```

**kernel PCA**
```{r}
library(geigen)
kernel_pca <- function(x.tr, x.ts, label.tr, d, flag){
  #x.tr and x.ts are feature*sample
  # flag =TRUE is for supervised kernel PCA and flag= False is for kernel pca
  # "d" is the dimension of the data in the new feature space
  n <- dim(x.tr)[2]
  I <- diag(n)
  e <- rep(1, n)
  s <- 1/n
  H <- I - s*tcrossprod(e)
  if (flag==TRUE){
    L <- label.tr %*% t(label.tr)
    cat("Flag is true\n")
    }else{
    cat("Flag is false\n")
    L <- I    
  }
    
  k <- t(x.tr) %*% x.tr
  Q <- k %*% H %*% L %*% H %*% k
  Q.svd <- svd(Q, nu=d, nv=d)
  U <- Q.svd$u[,1:d]
  V <- Q.svd$v[,1:d]
  D <- Q.svd$d[1:d]
  cat("Eigen values =", D , "\n")
  beta <- geigen(Q, k)
  mapped.tr <- beta$vectors %*% k
  mapped.ts <- beta$vectors %*% t(x.tr) %*% x.ts
  
  list(tr.dat=mapped.tr[1:d,], ts.dat=mapped.ts[1:d,])
}

```

```{r}
run_svm <- function(x.tr, x.ts){
  conf_matrix <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))
  #fit.svm <- ksvm(xtrain,label.tr,type="C-svc",kernel="rbfdot")
  fit_svm <- ksvm(prognosis~.,x.tr)
  pred_svm <- predict(fit_svm,newdata=x.ts,type="response")
  
  #fit.svm <- ksvm(xtrain,label.tr)
  #pred_svm <- predict(fit.svm,newdata=x.ts)
  results <- table(x.ts$prognosis,pred_svm)
  print(results)
  conf_matrix[1,1] <- conf_matrix[1,1] + results[1,1]
  conf_matrix[1,2] <- conf_matrix[1,2] + results[1,2]
  conf_matrix[2,1] <- conf_matrix[2,1] + results[2,1]
  conf_matrix[2,2] <- conf_matrix[2,2] + results[2,2]
  
  sens_svm <- conf_matrix[1,1]/sum(conf_matrix[1,])
  spec_svm <- conf_matrix[2,2]/sum(conf_matrix[2,])
  cat("Sensitvity = ", sens_svm, "\n")
  cat("Specificity = ", spec_svm, "\n")
  
}

```

**Part 1: Analyze for a random training and test set.**
```{r}
test <- sample(1:137,30)
x.ts <- t(data.matrix(prelim.in[test,grepl(".*calculated",colnames(prelim.in))]))
ytest <- prelim.in[test,c("prognosis")]
x.tr <- t(data.matrix(prelim.in[-test,grepl(".*calculated",colnames(prelim.in))]))
ytrain <- prelim.in[-test,c("prognosis")]

d=10

#kernel PCA
res <- kernel_pca((x.tr), (x.ts), as.numeric(levels(ytrain))[ytrain], d, FALSE)
xtrain <- t(res$tr.dat)
xtest <- t(res$ts.dat)
plot(xtrain[, 1:2], bg=ytrain, pch=21, cex=1.5)
xtrain.ker <- cbind(xtrain, prelim.in[-test,c("prognosis","Cytogenetic_risk")])
xtest.ker <- cbind(xtest, prelim.in[test,c("prognosis","Cytogenetic_risk")])
run_svm(xtrain.ker, xtest.ker)


# #R kernel PCA
# xtest <- prelim.in[test,grepl(".*calculated",colnames(prelim.in))]
# xtrain <- prelim.in[-test,grepl(".*calculated",colnames(prelim.in))]
# kpc <- kpca(~.,data=xtrain,kernel="rbfdot", kpar=list(sigma=0.2),features=2)
# plot(rotated(kpc),col=as.integer(ytrain),xlab="1st Principal Component",ylab="2nd Principal Component")
# emb <- predict(kpc,xtest)
# points(emb,col=as.integer(ytest))
# xtrain.ker.r <- cbind(rotated(kpc), prelim.in[-test,c("prognosis","Cytogenetic_risk")])
# xtest.ker.r <- cbind(emb, prelim.in[test,c("prognosis","Cytogenetic_risk")])
# run_svm(xtrain.ker.r, xtest.ker.r)

#Supervised PCA
sup.res <- kernel_pca((x.tr), (x.ts), as.numeric(levels(ytrain))[ytrain], d, TRUE)
sup.ts <- t(sup.res$ts.dat)
sup.tr <- t(sup.res$tr.dat)
plot(sup.tr[, 1:2], bg=ytrain, pch=21, cex=1.5)
xtrain.supervised <- cbind(sup.tr, prelim.in[-test,c("prognosis","Cytogenetic_risk")])
xtest.supervised <- cbind(sup.ts, prelim.in[test,c("prognosis","Cytogenetic_risk")])
run_svm(xtrain.supervised, xtest.supervised)

#basic PCA
princomp <- prcomp(prelim.in[,grepl(".*calculated",colnames(prelim.in))], center = T, scale = F)
summary(princomp)$importance[, 1:6] 
library(geneplotter); 
smoothScatter(princomp$x) #generates a smooth scatter plot that shows the density of the data points.
selected_gene_1 <- (which(abs(princomp$rotation[,1])>abs(mean(princomp$rotation[,1])+sd(princomp$rotation[,1]))))

selected_gene_2 <- (which(abs(princomp$rotation[,2])>abs(mean(princomp$rotation[,2])+sd(princomp$rotation[,2]))))
selected_gene_3 <- (which(abs(princomp$rotation[,3])>abs(mean(princomp$rotation[,3])+sd(princomp$rotation[,3]))))
library(grid)
library(VennDiagram)

gene.set <- list(first= selected_gene_1, second= selected_gene_2, third = selected_gene_3)
venn.plot <- venn.diagram(gene.set, filename = NULL, fill = c("red", "blue", "yellow"),force.unique)
plot.new()
grid.draw(venn.plot)

xtrain.basic <- cbind(princomp$x[-test, 1:d], prelim.in[-test,c("prognosis","Cytogenetic_risk")])
xtest.basic <- cbind(princomp$x[test, 1:d], prelim.in[test,c("prognosis","Cytogenetic_risk")])
run_svm(xtrain.basic, xtest.basic)

```
```{r}
#some plots for showing the laoding matrix
library(reshape2)
library(ggplot2)
 
melted <- cbind(gene.name[1:100], melt((princomp$rotation[1:100,1:4])))

ggplot(data=melted) +geom_bar(aes(x=Var1[1:100], y=value[1:100], fill=gene.name[1:100]), stat="identity") + facet_wrap(~Var2)
```


**Prepare folds and confusion matrix for cross validation.**
```{r}
k<- 5
set.seed(1234)
folds <- cvFolds(nrow(prelim.in), K = k)
conf_matrix_ker <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))
conf_matrix_sup <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))
conf_matrix_basic <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))
conf_matrix_ker_R <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))
conf_matrix_ica <- matrix(0,nrow=2,ncol=2,dimnames=list(c("truePoor","trueNotPoor"),c("predPoor","predNotPoor")))

gene.list = list("1"="", "2"="", "3"="", "4"="", "5"="")

```

**Perform cross validation.**
```{r}
for (f in 1:k) {
  
  x.ts <- t(data.matrix(prelim.in[folds$subsets[folds$which==f,],grepl(".*calculated",colnames(prelim.in))]))
  ytest <- prelim.in[folds$subsets[folds$which==f,],c("prognosis")]
  x.tr <- t(data.matrix(prelim.in[folds$subsets[folds$which!=f,],grepl(".*calculated",colnames(prelim.in))]))
  ytrain <- prelim.in[folds$subsets[folds$which!=f,],c("prognosis")]
  d = 10
  
  #kernel PCA
  res <- kernel_pca((x.tr), (x.ts),  as.numeric(levels(ytrain))[ytrain], d, FALSE)
  xtrain <- t(res$tr.dat)
  xtest <- t(res$ts.dat)
  xtrain <- cbind(xtrain, prelim.in[folds$subsets[folds$which!=f,],c("prognosis","Cytogenetic_risk")])
  xtest <- cbind(xtest, prelim.in[folds$subsets[folds$which==f,],c("prognosis","Cytogenetic_risk")])

  fit_svm <- ksvm(prognosis~.,xtrain)
  pred_svm <- predict(fit_svm,newdata=xtest,type="response")

  results.ker <- table(ytest,pred_svm)
  
  conf_matrix_ker[1,1] <- conf_matrix_ker[1,1] + results.ker[1,1]
  conf_matrix_ker[1,2] <- conf_matrix_ker[1,2] + results.ker[1,2]
  conf_matrix_ker[2,1] <- conf_matrix_ker[2,1] + results.ker[2,1]
  conf_matrix_ker[2,2] <- conf_matrix_ker[2,2] + results.ker[2,2] 
 
  ###############
  #supervised PCA
  cat("supervised PCA\n")
  sup.res <- kernel_pca((x.tr), (x.ts), as.numeric(levels(ytrain))[ytrain], d, TRUE)
  sup.ts <- t(sup.res$ts.dat)
  sup.tr <- t(sup.res$tr.dat)
  xtrain.supervised <- cbind(sup.tr, prelim.in[folds$subsets[folds$which!=f,],c("prognosis","Cytogenetic_risk")])
  xtest.supervised <- cbind(sup.ts, prelim.in[folds$subsets[folds$which==f,],c("prognosis","Cytogenetic_risk")])
  
  fit_svm <- ksvm(prognosis~.,xtrain.supervised)
  pred_svm <- predict(fit_svm,newdata=xtest.supervised,type="response")

  results.sup <- table(ytest,pred_svm)
  
  conf_matrix_sup[1,1] <- conf_matrix_sup[1,1] + results.sup[1,1]
  conf_matrix_sup[1,2] <- conf_matrix_sup[1,2] + results.sup[1,2]
  conf_matrix_sup[2,1] <- conf_matrix_sup[2,1] + results.sup[2,1]
  conf_matrix_sup[2,2] <- conf_matrix_sup[2,2] + results.sup[2,2] 
  ##############
  cat("basic PCA\n")
  #basic PCA
  princomp <- prcomp(prelim.in[,grepl(".*calculated",colnames(prelim.in))], center = T, scale = F)
  selected_gene <- (which(abs(princomp$rotation[,1])>abs(mean(princomp$rotation[,1])+sd(princomp$rotation[,1]))))
  gene.list$f <- selected_gene
  
  xtrain.basic <- cbind(princomp$x[folds$subsets[folds$which!=f,], 1:d], prelim.in[folds$subsets[folds$which!=f,],c("prognosis","Cytogenetic_risk")])
  xtest.basic <- cbind(princomp$x[folds$subsets[folds$which==f,], 1:d], prelim.in[folds$subsets[folds$which==f,],c("prognosis","Cytogenetic_risk")])
  fit_svm <- ksvm(prognosis~.,xtrain.basic)
  pred_svm <- predict(fit_svm,newdata=xtest.basic,type="response")

  results.basic <- table(ytest,pred_svm)
  
  conf_matrix_basic[1,1] <- conf_matrix_basic[1,1] + results.basic[1,1]
  conf_matrix_basic[1,2] <- conf_matrix_basic[1,2] + results.basic[1,2]
  conf_matrix_basic[2,1] <- conf_matrix_basic[2,1] + results.basic[2,1]
  conf_matrix_basic[2,2] <- conf_matrix_basic[2,2] + results.basic[2,2] 
#   cat("R kernel PCA \n")
#   #R kernel PCA
#   xtest.ker.R <- prelim.in[folds$subsets[folds$which==f,],grepl(".*calculated",colnames(prelim.in))]
#   xtrain.ker.R <- prelim.in[folds$subsets[folds$which!=f,],grepl(".*calculated",colnames(prelim.in))]
#   kpc <- kpca(~.,data=xtrain.ker.R,kernel="rbfdot", kpar=list(sigma=0.2),features=2)
#   emb <- predict(kpc,xtest.ker.R)
#   xtrain.ker.r <- cbind(rotated(kpc), prelim.in[folds$subsets[folds$which!=f,],c("prognosis","Cytogenetic_risk")])
#   xtest.ker.r <- cbind(emb, prelim.in[folds$subsets[folds$which==f,],c("prognosis","Cytogenetic_risk")])
#   
#   fit_svm <- ksvm(prognosis~.,xtrain.ker.r)
#   pred_svm <- predict(fit_svm,newdata=xtest.ker.r,type="response")
# 
#   results <- table(ytest,pred_svm)
#   
#   conf_matrix_ker_R[1,1] <- conf_matrix_ker_R[1,1] + results[1,1]
#   conf_matrix_ker_R[1,2] <- conf_matrix_ker_R[1,2] + results[1,2]
#   conf_matrix_ker_R[2,1] <- conf_matrix_ker_R[2,1] + results[2,1]
#   conf_matrix_ker_R[2,2] <- conf_matrix_ker_R[2,2] + results[2,2] 
}
```

**Process CV results.**
```{r}
venn.plot <- venn.diagram(gene.list, filename = NULL, fill = c("red", "blue", "yellow", "green", "orange"),force.unique)
plot.new()
grid.draw(venn.plot)

(sens_svm_basic <- conf_matrix_basic[1,1]/sum(conf_matrix_basic[1,]))
(spec_svm_basic <- conf_matrix_basic[2,2]/sum(conf_matrix_basic[2,]))


(sens_svm_ker <- conf_matrix_ker[1,1]/sum(conf_matrix_ker[1,]))
(spec_svm_ker <- conf_matrix_ker[2,2]/sum(conf_matrix_ker[2,]))


(sens_svm_sup <- conf_matrix_sup[1,1]/sum(conf_matrix_sup[1,]))
(spec_svm_sup <- conf_matrix_sup[2,2]/sum(conf_matrix_sup[2,]))
```

```{r}
counts <- data.frame(sensetivity = c(sens_svm_basic,sens_svm_ker,sens_svm_sup ), specificty= c(spec_svm_basic,spec_svm_ker,spec_svm_sup))
row.names(counts) <- c("Basic PCA","Kernelized PCA","Supervised PCA")
counts

barplot(c(counts$sensetivity, counts$specificty), main="preformance of SVM on PCa versions",
  xlab="Number of Gears", col=c("red", "blue", "green"),
    legend = c("Basic PCA","Kernelized PCA","Supervised PCA"), beside=TRUE)

```



